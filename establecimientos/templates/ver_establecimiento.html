{% extends 'base.html' %}
{% load static %}

{% block title %}{{ establecimiento.nombre }} - SportsNet{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/ver_establecimiento.css' %}">
{% endblock %}

{% block content %}
<div class="detalle-container">
  

  <div class="detalle-header">
    <h1 class="detalle-titulo">Establecimiento : {{ establecimiento.nombre }}</h1>
    <div class="detalle-botones">

      {% if request.user == establecimiento.dueno.usuario %}
      <a href="{% url 'establecimientos:editar_establecimiento' establecimiento.id %}" class="btn">Editar</a>
      <a href="{% url 'cuentas:home' %}" class="btn">Volver</a>
      {% else %}
      <a href="{% url 'cuentas:home' %}" class="btn">Volver</a>
      {% endif %}

      
    </div>
  </div>


  <div class="detalle-grid">

    <div class="card">
      <h2 class="card-titulo">Información General</h2>
      
      <div class="info-item">
        <span class="info-label">Dirección:</span>
        <span class="info-valor">{{ establecimiento.direccion }}</span>
      </div>
      
      <div class="info-item">
        <span class="info-label">Teléfono:</span>
        <span class="info-valor">{{ establecimiento.telefono_contacto }}</span>
      </div>
      
      <div class="info-item">
        <span class="info-label">Email:</span>
        <span class="info-valor">{{ establecimiento.correo_contacto }}</span>
      </div>


      <div class="card-titulo" style="margin-top: 1.5rem;">Comodidades</div>
      <div class="comodidades-grid">
        <div class="comodidad-item">
          <div class="comodidad-nombre">Estacionamiento</div>
          <div class="comodidad-estado">
            {% if establecimiento.estacionamiento_disponible %}Disponible{% else %}No disponible{% endif %}
          </div>
        </div>
        
        <div class="comodidad-item">
          <div class="comodidad-nombre">Camarines</div>
          <div class="comodidad-estado">
            {% if establecimiento.camarines_disponible %}Disponible{% else %}No disponible{% endif %}
          </div>
        </div>
      </div>
    </div>

   
    <div class="card card-mapa">
      <h2 class="card-titulo">Ubicación</h2>
      <div id="mapa"></div>
    </div>
  </div>


  {% if horarios_completos %}
    <div class="seccion">
    <h2 class="seccion-titulo">Horarios</h2>
    <table class="horarios-table">
    <thead>
    <tr>
    <th>Día</th>
    <th>Apertura</th>
    <th>Cierre</th>
    </tr>
    </thead>
    <tbody>
    {% for item in horarios_completos %}
    <tr>
    <td>
    <strong>{{ item.dia }}</strong>
    {% if not item.horario %}
    {% endif %}
    </td>
    <td>
    {% if item.horario %}
    {{ item.horario.hora_apertura|time:"H:i" }}
    {% else %}
    <span>Cerrado</span>
    {% endif %}
    </td>
    <td>
    {% if item.horario %}
    {{ item.horario.hora_cierre|time:"H:i" }}
    {% else %}
    <span>Cerrado</span>
    {% endif %}
    </td>
    </tr>
    {% endfor %}
    </tbody>
    </table>
    </div>
    {% else %}
    <div class="seccion">
    <h2 class="seccion-titulo">Horarios</h2>
    <p class="texto-vacio">No hay horarios configurados</p>
    </div>
  {% endif %}


  <div class="seccion">
    <h2 class="seccion-titulo">Canchas Disponibles</h2>
    {% if request.user == establecimiento.dueno.usuario %}
      <div class="detalle-botones"><a href="{% url 'establecimientos:crear_cancha' establecimiento.id %}" class="btn">Crear Cancha</a></div>
    {% endif %}
    
    
    {% if establecimiento.canchas.all %}
    <div class="canchas-grid">
      {% for cancha in establecimiento.canchas.all %}
      <div class="cancha-card">
        <div class="cancha-nombre">{{ cancha.nombre }}</div>
        
        <div class="cancha-detalle">
          <strong>Deporte:</strong> {{ cancha.get_deporte_display }}
        </div>
        
        <div class="cancha-detalle">
          <strong>Superficie:</strong> {{ cancha.get_superficie_display }}
        </div>
        
        <div class="cancha-detalle">
          <strong>Iluminación:</strong> {{ cancha.iluminacion }}
        </div>
        
        <div class="cancha-detalle">
          <strong>Tipo:</strong> {% if cancha.interior %}Interior{% else %}Exterior{% endif %}
        </div>
        
        <div class="cancha-detalle">
          <strong>Precio/bloque:</strong> <span class="precio-bloque">${{ cancha.valor_por_bloque }}</span>
        </div>

        <a href="{% url 'establecimientos:ver_cancha' cancha.id %}" class="btn">Ver detalles</a>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="texto-vacio">No hay canchas registradas</p>
    {% endif %}
  </div>

</div>

<!-- mapa  
 cdnjs
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
-->

<!-- cdn -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<script defer>
  console.log("js cargado")
  // valores por defecto
  const direccion = "{{ establecimiento.direccion }}";
  const lat = parseFloat("{{ establecimiento.latitud|floatformat:7 }}".replace(",", "."));
  const lon = parseFloat("{{ establecimiento.longitud|floatformat:7 }}".replace(",", "."));

  const esUbicacionDefecto = (lat === 57.0092 && lon === -135.3208);

  // Inicializar mapa
  const mapa = L.map('mapa').setView([lat, lon], 15);

  // Tiles OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 19
  }).addTo(mapa);

  if (esUbicacionDefecto) {
    L.marker([lat, lon], {
      icon: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      })
    })
    .addTo(mapa)
    .bindPopup(
      "<strong>{{ establecimiento.nombre }}</strong><br>" +
      "{{ establecimiento.direccion }} <br>"+
      "<small style='color: #9ca3af;'>Coordenadas no encontradas</small>"
    )
    .openPopup();
  } else {
    L.marker([lat, lon])
      .addTo(mapa)
      .bindPopup(
        "<strong>{{ establecimiento.nombre }}</strong><br>" +
        "{{ establecimiento.direccion }}"
      )
      .openPopup();
  }
    
</script>



{% endblock %}