{% extends 'base.html' %}
{% load static %}

{% block title %}Reservar - {{ cancha.nombre }}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'crear_reserva.css' %}">
{% endblock %}

{% block content %}
<div class="reserva-container">
  <h1 class="reserva-title">Reservar {{ cancha.nombre }}</h1>

  <div class="contenedor-dos-columnas">
    
    <div class="columna-formulario">
      <h2 class="seccion-titulo">Crear Reserva</h2>

      <div class="cancha-info">
        <div class="info-item">
          <span class="info-label">Cancha:</span>
          <span class="info-valor">{{ cancha.nombre }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Establecimiento:</span>
          <span class="info-valor">{{ cancha.establecimiento.nombre }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Deporte:</span>
          <span class="info-valor">{{ cancha.get_deporte_display }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Precio por bloque:</span>
          <span class="precio-destaque">${{ cancha.valor_por_bloque }}</span>
        </div>
      </div>

      <form method="POST" class="formulario">
        {% csrf_token %}

        <div class="form-group">
          <label for="{{ form.fecha.id_for_label }}">{{ form.fecha.label }}</label>
          {{ form.fecha }}
          {% if form.fecha.help_text %}<span class="helptext">{{ form.fecha.help_text }}</span>{% endif %}
          {% if form.fecha.errors %}<span class="error-message">{{ form.fecha.errors.0 }}</span>{% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.hora_inicio.id_for_label }}">{{ form.hora_inicio.label }}</label>
          {{ form.hora_inicio }}
          {% if form.hora_inicio.errors %}<span class="error-message">{{ form.hora_inicio.errors.0 }}</span>{% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.duracion_bloques.id_for_label }}">{{ form.duracion_bloques.label }}</label>
          {{ form.duracion_bloques }}
          {% if form.duracion_bloques.help_text %}<span class="helptext">{{ form.duracion_bloques.help_text }}</span>{% endif %}
          {% if form.duracion_bloques.errors %}<span class="error-message">{{ form.duracion_bloques.errors.0 }}</span>{% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.comentario.id_for_label }}">{{ form.comentario.label }}</label>
          {{ form.comentario }}
        </div>

        <div class="resumen">
          <div class="resumen-item">
            <span>Bloque de 30 min:</span>
            <span>${{ cancha.valor_por_bloque }}</span>
          </div>
          <div class="resumen-item">
            <span id="cantidad-label">Cantidad (1 bloque):</span>
            <span id="cantidad-valor">1 × ${{ cancha.valor_por_bloque }}</span>
          </div>
          <div class="resumen-item">
            <span>Total:</span>
            <span id="total-precio">${{ cancha.valor_por_bloque }}</span>
          </div>
        </div>

        <button type="submit" class="boton-reservar">Confirmar Reserva</button>
      </form>
<br>
      <div>
        <a  class="boton-reservar" href="{% url 'establecimientos:ver_establecimiento' cancha.establecimiento.id %}" >Volver</a>
      </div>
    </div>


    <div class="columna-reservas">
      <h2 class="seccion-titulo">Reservas Existentes</h2>

      {% if reservas_cancha %}
        <div class="reservas-lista">
          {% for reserva in reservas_cancha %}
            <div class="cancha-info">
              <div class="reserva-fecha">{{ reserva.fecha|date:"d/m/Y" }}</div>
              
              <div class="info-item">
                <span>Hora:</span>
                <strong>{{ reserva.hora_inicio|time:"H:i" }} - {{ reserva.hora_fin|time:"H:i" }}</strong>
              </div>
              
              <div class="info-item">
                <span>Duración:</span>
                <strong>{{ reserva.duracion_bloques }} bloque{{ reserva.duracion_bloques|pluralize }}</strong>
              </div>
              
              <div class="info-item">
                Usuario: <strong>{{ reserva.usuario.username }}</strong>
              </div>
              
              <span class="info-item">
                Estado : {{ reserva.get_estado_display }}
              </span>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="sin-reservas">
          <p>No hay reservas para esta cancha</p>
        </div>
      {% endif %}
    </div>

  </div>
</div>

<script defer>
  console.log("precio total actualizado");
document.addEventListener('DOMContentLoaded', function() {
  const duracionInput = document.querySelector('input[name="duracion_bloques"]');
  const precioBase = {{ cancha.valor_por_bloque }};

  if (duracionInput) {
    duracionInput.addEventListener('change', actualizarPrecio);
    duracionInput.addEventListener('input', actualizarPrecio);
  }

  function actualizarPrecio() {
    const duracion = parseInt(duracionInput.value) || 1;
    const total = precioBase * duracion;
    document.getElementById('cantidad-label').textContent = `Cantidad (${duracion} bloque):`;
    document.getElementById('cantidad-valor').textContent = `${duracion} x $${precioBase}`;
    document.getElementById('total-precio').textContent = `$${total}`;
  }
});
</script>

{% endblock %}

